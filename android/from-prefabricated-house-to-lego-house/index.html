<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>Hannes Dorfmann</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="The evolution of the Repository Pattern - Be aware of over abstraction. Repository Pattern can lead to over architecture and unneccessary abstractions.">
  <meta name="author" content="Hannes Dorfmann">
  <meta name="generator" content="Hugo 0.73.0" />
  <meta property='og:title' content='The evolution of the Repository Pattern - Be aware of over abstraction'/>
  <meta property='og:description' content='The evolution of the Repository Pattern - Be aware of over abstraction. Repository Pattern can lead to over architecture and unneccessary abstractions.' />


  <!-- plugins -->
  
  <link rel="stylesheet" href="https://hannesdorfmann.com/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://hannesdorfmann.com/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://hannesdorfmann.com/plugins/themify-icons/themify-icons.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://hannesdorfmann.com/css/style.min.css" media="screen">

  <!-- Syntax highlightning Stylesheet -->
  
  <link rel="stylesheet" href="https://hannesdorfmann.com/css/syntax-highlighting.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://hannesdorfmann.com/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://hannesdorfmann.com/images/favicon.png " type="image/x-icon">

  </head><body class="theme-light">
<!-- preloader start -->
<div class="preloader">
  <div class="loader">
    <span class="dot"></span>
    <div class="dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
</div>
<!-- preloader end -->
<header class="navigation">
  <nav class="navbar navbar-expand-lg navbar-light">
    
    <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navogation"
      aria-controls="navogation" aria-expanded="false" aria-label="Toggle navigation">
      <span id="navbar-toggler" class="ti-menu"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navogation">
      <ul class="navbar-nav ml-auto">
        
        
        <li class="nav-item">
          <a class="nav-link text-uppercase text-dark" href="https://hannesdorfmann.com">Home</a>
        </li>
        
        
        
        <li class="nav-item">
          <a class="nav-link text-uppercase text-dark" href="https://hannesdorfmann.com/about">About</a>
        </li>
        
        
        
        <li class="nav-item">
          <a class="nav-link text-uppercase text-dark" href="https://hannesdorfmann.com/presentations">Presentations</a>
        </li>
        
        
        
        <li class="nav-item">
          <a class="nav-link text-uppercase text-dark" href="https://hannesdorfmann.com/contact">Contact</a>
        </li>
        
        
        <li class="nav-item">
          <a class="nav-link text-uppercase text-dark" onclick="toggleTheme()">
            <img id="themeSwitcher" class="navbar-nav ml-lg-4" src="/images/theme/moon.svg"/>
          </a>
        </li>
      </ul>
      
      <!-- search -->
      <form class="form-inline position-relative ml-lg-4" action="https://hannesdorfmann.com/search">
        <input class="form-control px-0 w-100" type="search" placeholder="Search" id="search-query" name="s">
        <button class="search-icon" type="submit"><i class="ti-search text-dark"></i></button>
      </form>
      
    </div>
  </nav>
</header>


<section class="section bg-secondary">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h1>The evolution of the Repository Pattern - Be aware of over abstraction</h1>
      </div>
    </div>
  </div>
</section>



<section>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <ul class="list-inline d-flex justify-content-between py-3">
          <li class="list-inline-item"><i class="ti-user mr-2"></i>Post by Hannes Dorfmann</li>
          <li class="list-inline-item"><i class="ti-calendar mr-2"></i>Jul 17, 2016</li>
        </ul>
        <article class="content">
          
          <p>A listener from our podcast, <a href="https://github.com/artem-zinnatullin/TheContext-Podcast">The Context</a>, that Artem Zinnatullin and I run asked me, if I can give him an example of the Repository Pattern. So I googled around and stumbled upon some blog posts and found out that the term Repository Pattern is used and described in many different ways. In this blog post I want give you a brief history of the Repository Pattern and I want to discuss why I think the Repository Pattern could lead to over abstraction and over engineering.</p>
<p>Before we get started, I wanted to say that the term <em>Repository Pattern</em> is used and defined in different ways in different contexts and different programming languages. Therefore, I split this post into two parts: In the first part I want to discuss why I think the  &ldquo;original&rdquo; definition of the Repository Pattern is an over engineered abstraction you very very rarely need and in the second part I want to show a common and popular definition of the Repository Pattern that may be a better choice for the average use case.</p>
<h2 id="the-original-repository-pattern">The original Repository Pattern</h2>
<p>As far as I know the repository pattern was first introduced by Martin Fowler et al. in the book  <a href="http://martinfowler.com/eaaCatalog/repository.html">Patterns of Enterprise Application Architecture</a>.
<a href="https://medium.com/@krzychukosobudzki/repository-design-pattern-bc490b256006#.h7cm2b24q">This blog post</a> by Krzychu Kosobudzki or <a href="http://panavtec.me/what-is-the-repository-pattern-and-why-im-not-going-to-use-it-on-android">this blog post</a> Christian Panadero give an example of the usage of this pattern in the context of android development. In my opinion the original repository pattern is an over engineered abstraction layer you very very rarely need. Especially on Android. What do I mean with over engineered? Let&rsquo;s have a look at the example from Krzychu Kosobudzki&rsquo;s blog post:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Repository</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="n">T</span> <span class="n">item</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>What is the <em>Specification</em> type? Basically <em>Specification</em> is just an interface like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">Specification</span> <span class="o">{</span> <span class="o">}</span>

<span class="kd">interface</span> <span class="nc">SqlSpecification</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">toSqlQuery</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div><p>Then we could have concrete <em>Specification</em> to query all list of <em>News</em> from SQLite database, ordered by date, like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">NewestNewsesSqlSpecification</span> <span class="kd">implements</span> <span class="n">SqlSpecification</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toSqlQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                <span class="s">&#34;SELECT * FROM %1$s ORDER BY `%2$s` DESC;&#34;</span><span class="o">,</span>
                <span class="n">NewsTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">,</span>
                <span class="n">NewsTable</span><span class="o">.</span><span class="na">Fields</span><span class="o">.</span><span class="na">DATE</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Another example of a <em>Specification</em> looks as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewsByIdSqlSpecification</span> <span class="kd">implements</span> <span class="n">SqlSpecification</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">NewsByIdSpecification</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toSqlQuery</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                <span class="s">&#34;SELECT * FROM %1$s WHERE `%2$s` = %3$d&#39;;&#34;</span><span class="o">,</span>
                <span class="n">NewsTable</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">,</span>
                <span class="n">NewsTable</span><span class="o">.</span><span class="na">Fields</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span>
                <span class="n">id</span>
        <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>And then use that components like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewsSqlRepository</span> <span class="kd">implements</span> <span class="n">Repository</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SqlSpecification</span> <span class="n">sqlSpecification</span> <span class="o">=</span> <span class="o">(</span><span class="n">SqlSpecification</span><span class="o">)</span> <span class="n">specification</span><span class="o">;</span>

        <span class="n">SQLiteDatabase</span> <span class="n">database</span> <span class="o">=</span> <span class="n">openHelper</span><span class="o">.</span><span class="na">getReadableDatabase</span><span class="o">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="n">newses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="n">Cursor</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="na">rawQuery</span><span class="o">(</span><span class="n">sqlSpecification</span><span class="o">.</span><span class="na">toSqlQuery</span><span class="o">());</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">cursor</span><span class="o">.</span><span class="na">moveToPosition</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="n">newses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">toNewsMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">cursor</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">cursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">newses</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>Again, all code snippets shown above are borrowed from <a href="https://medium.com/@krzychukosobudzki/repository-design-pattern-bc490b256006#.h7cm2b24q">Krzychu Kosobudzki blog post</a>.</p>
<p>Usually you use <em>NewsRepository</em> i.e. in your Presenter (MVP) or use case / interactor if you are following the clean architecture like this: <em>newsRepository.query(new NewestNewsesSqlSpecification())</em>.</p>
<p>So far so good. Before we continue, I want to ask you two essential questions:</p>
<p>First question: <strong>Why and when do we use the repository pattern?</strong> I want to link to the book <a href="http://martinfowler.com/eaaCatalog/repository.html">Patterns of Enterprise Application Architecture</a> by Martin Fowler et al.</p>
<blockquote>
<p>The Repository will carry out the appropriate operations behind the scenes. Conceptually, a Repository encapsulates the set of objects persisted in a data store and the operations performed over them, providing a more object-oriented view of the persistence layer. Repository also supports the objective of achieving a clean separation and one-way dependency between the domain and data mapping layers.</p>
</blockquote>
<p>Second Question: <strong>What are the benefits of abstractions like <em>Specification</em>?</strong></p>
<ul>
<li>Single responsibility: This class is responsible to create a &ldquo;criteria&rdquo;. In the case of <em>NewestNewsesSqlSpecification</em> this criteria is translated to an SQL string.</li>
<li>Hide implementation details: The SQL Statement is hidden in <em>NewestNewsesSqlSpecification</em>, so that no other class has to know about SQL at all.</li>
<li>We can reuse Specifications: Imagine a Specification with a SQL WHERE clause. We could define such a Specification once and reuse it whenever we need a different WHERE clause based specification.</li>
<li>Open / Closed principle: As Krzychu Kosobudzki pointed out correctly, this allows to create new specifications (and therefore new functionality) without having to touch something else in your code base.</li>
</ul>
<p>What are the disadvantages with that extra abstraction layer?
Well, now whoever calls <em>newsRepository.query(new NewestNewsesSqlSpecification())</em> has to know which <em>Specification</em> to pass in. That is not a problem per se, but developers begin to over abstract that pattern. For example, Krzychu Kosobudzki says that with the repository pattern we can change concrete implementation as requirements changes. He gives the example of using Realm instead of SQLite database:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewsRealmRepository</span> <span class="kd">implements</span> <span class="n">Repository</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RealmSpecification</span> <span class="n">realmSpecification</span> <span class="o">=</span> <span class="o">(</span><span class="n">RealmSpecification</span><span class="o">)</span> <span class="n">specification</span><span class="o">;</span>

        <span class="n">Realm</span> <span class="n">realm</span> <span class="o">=</span> <span class="n">Realm</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">realmConfiguration</span><span class="o">);</span>
        <span class="n">RealmResults</span><span class="o">&lt;</span><span class="n">NewsRealm</span><span class="o">&gt;</span> <span class="n">realmResults</span> <span class="o">=</span> <span class="n">realmSpecification</span><span class="o">.</span><span class="na">toRealmResults</span><span class="o">(</span><span class="n">realm</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="n">newses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">NewsRealm</span> <span class="n">news</span> <span class="o">:</span> <span class="n">realmResults</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">newses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">toNewsMapper</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">news</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">realm</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">newses</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>As you see there is another subtype of <em>Specification</em> for Realm:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RealmSpecification</span> <span class="kd">extends</span> <span class="n">Specification</span> <span class="o">{</span>
    <span class="n">RealmResults</span><span class="o">&lt;</span><span class="n">NewsRealm</span><span class="o">&gt;</span> <span class="nf">toRealmResults</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewsByIdSpecification</span> <span class="kd">implements</span> <span class="n">RealmSpecification</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">NewsByIdSpecification</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">RealmResults</span><span class="o">&lt;</span><span class="n">NewsRealm</span><span class="o">&gt;</span> <span class="nf">toRealmResults</span><span class="o">(</span><span class="n">Realm</span> <span class="n">realm</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">realm</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">NewsRealm</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">equalTo</span><span class="o">(</span><span class="n">NewsRealm</span><span class="o">.</span><span class="na">Fields</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>The problem is that whoever calls <em>newsRepository.query(&hellip;)</em> has to know whether it has to pass in a <em>NewestNewsesSqlSpecification</em> or <em>NewestNewsesRealmSpecification</em>. So is it really that easy to change your implementation from SQLite to Realm? No, it&rsquo;s not because you have to change the specifications everywhere from <em>FooSqlSpecification</em> to <em>FooRealmSpecification</em>. There is also one big code smell coming along with this:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">SqlSpecification</span> <span class="n">sqlSpecification</span> <span class="o">=</span> <span class="o">(</span><span class="n">SqlSpecification</span><span class="o">)</span> <span class="n">specification</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">News</span><span class="o">&gt;</span> <span class="nf">query</span><span class="o">(</span><span class="n">Specification</span> <span class="n">specification</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">RealmSpecification</span> <span class="n">realmSpecification</span> <span class="o">=</span> <span class="o">(</span><span class="n">RealmSpecification</span><span class="o">)</span> <span class="n">specification</span><span class="o">;</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div><p>Whenever you are programming against an interface but you have to cast an interface to a concrete class, in 95% of the time you are doing something wrong!</p>
<p>Martin Fowler et al. didn&rsquo;t make a statement about Repository Pattern and changing concrete implementation (i.e. SQLite to Realm). Fowler et al, described the repository pattern  as</p>
<blockquote>
<p>adding this layer helps minimize duplicate query logic.</p>
</blockquote>
<p>So the original definition of the repository pattern is all about minimizing duplicate query logic and not necessarily to build an abstraction layer to change the underlying database.</p>
<p>I don&rsquo;t want to blame anybody. This is not a Android related problem, we also see that quite often in Java EE world, especially in spring framework powered backends.</p>
<h2 id="evolution-of-the-repository-pattern-term">Evolution of the Repository Pattern term</h2>
<p>In android development the term Repository Pattern is quite often used in combination with Clean Architecture. So did Fernando Cejas in his excellent blog post <a href="http://fernandocejas.com/2014/09/03/architecting-android-the-clean-way/">Architecting Androidâ€¦The clean way?</a> (scroll down to &ldquo;Data layer&rdquo; section). Interesting enough, he also links to the original definition of the Repository Pattern by Martin Fowler et al. However, Fernando Cejas says:</p>
<blockquote>
<p>All data needed for the application comes from this layer through a Repository implementation (the interface is in the domain layer) that uses a Repository Pattern with a strategy that, through a factory, picks different data sources depending on certain conditions.</p>
</blockquote>
<p><img src="/images/repository_pattern.png" alt="Repository Pattern"></p>
<blockquote>
<p>The idea behind all this is that the data origin is transparent for the client, which does not care if the data is coming from memory, disk or the cloud, the only truth is that the data will arrive and will be got.</p>
</blockquote>
<p>As you can see here, the term <em>Repository Pattern</em> is used to describe something slightly different. You can see it even more clear if you check out Fernando&rsquo;s <a href="https://github.com/android10/Android-CleanArchitecture/tree/master/data/src/main/java/com/fernandocejas/android10/sample/data/repository">Clean Architecture Sample Project</a> on Github. In his sample he uses RxJava. For my blog post I have removed RxJava in the code snippets below for better understanding if you don&rsquo;t have prior RxJava knowledge. I have also simplified the code a little bit to focus on the important things. For example Fernando wants to load an User by his id:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="o">{</span>
  <span class="n">User</span> <span class="nf">user</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div><p>The concrete implementation of that repository:</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">class</span> <span class="nc">UserDataRepository</span> <span class="kd">implements</span> <span class="n">UserRepository</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="n">UserDataStoreFactory</span> <span class="n">userDataStoreFactory</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">User</span> <span class="nf">user</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">UserDataStore</span> <span class="n">userDataStore</span> <span class="o">=</span> <span class="n">userDataStoreFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">userDataStore</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p>An <em>UserDataStore</em> is, as the name already suggests, responsible to load a User from a store like disk or a backend (cloud).</p>
<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">interface</span> <span class="nc">UserDataStore</span> <span class="o">{</span>
  <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">DiskUserDataStore</span> <span class="kd">implements</span> <span class="n">UserDataStore</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">DiskCache</span><span class="o">&lt;</span><span class="n">Int</span><span class="o">,</span> <span class="n">User</span><span class="o">&gt;</span> <span class="n">userCache</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">){</span>
    <span class="k">return</span> <span class="n">userCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">CloudUserDataStore</span> <span class="kd">implements</span> <span class="n">UserDataStore</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUser</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">){</span>
    <span class="c1">// Make an HTTP request and return User.
</span><span class="c1"></span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div><p><em>UserDataStoreFactory</em> is the component that decides which <em>UserDataStore</em> to use when someone calls <em>UserRepository.getUser(userId)</em>. For example the factory could check if <em>DiskUserDataStore</em> has a User and if the User object is expired then the factory returns <em>CloudUserDataStore</em>, otherwise <em>DiskUserDataStore</em>. The factory could also take into account if the smartphone  has an active internet connection or not. I guess you get the point.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Fernando Cejas interpretation of the Repository Pattern is representative of other developers that nowadays interpret the Repository Pattern in a similar way. However, it has not much in common with the &ldquo;original&rdquo; definition of the Repository Pattern by Martin Fowler et al. Wasn&rsquo;t the repository pattern meant to be used to minimizing duplicate query logic? Martin Fowler didn&rsquo;t say anything about loading users from different UserDataStores. Where did the <em>Specification</em> class go?</p>
<p>If you compare both, the original Repository Pattern and the later one, you will see that actually they are trying to solve two different kind of problems. While the original one tries to minimize duplicate query logic (by open / closed principle) the later one tries to hide the concrete data store your app is talking to. But from my point of view you can&rsquo;t really solve both problems at the same time within the same pattern as Krzychu tried in his blog post by adding another abstraction. You have to choose which problem you actually want to solve (you can chain both patterns together though).</p>
<p>So why are both patterns called Repository Pattern? This happens quite often in history. A name gets (re)used for different purpose. For example Trygve Reenskaug introduced Model-View-Controller in the 1970s but his definition has nothing in common with what we nowadays call MVC, i.e. describing Activities as Controller on android, UIController on iOS, Controller in backends and so on. The same happened to the term Repository Pattern.</p>
<p>No worries, evolution is good. We should just remember where we came from and why it has evolved to what it is used now, for better understanding where we are going. The original Repository Pattern was designed for <strong>Enterprise Applications</strong> to reduce duplication of query logic. Usually, your android app is not a enterprise application. Normally, in your android app you should follow Fernando Cejas definition of the Repository Pattern because mostly you want to hide the underlying data store implementation to be more flexible for future requirement changes and consequential refactoring.</p>
<p><strong>But,</strong> if you take a closer look at the later interpretation of the Repository Pattern you will come to the conclusion that basically it just says: program against an interface so that you can change implementation details later and follow the single responsibility principle. That&rsquo;s what all the Clean Architecture and Repository Pattern blah blah is about.</p>
<p>Don&rsquo;t over abstract. Don&rsquo;t over engineer. For example, if you start an app from scratch, yes, you should define an interface like <em>UserRepo</em> and all your business logic or domain layer or whatever layer should program agains this interface. However, if you only have one backend to load data from, then your <em>UserRepo</em> implementation should make these http calls directly in a concrete UserRepo class implementing the UserRepo interface. No need for <em>UserDataStore</em>, <em>CloudUserDataStore</em> and <em>UserDataStoreFactory</em>.</p>
<p>You may ask yourself: What if one day my requirements change and I have to use Realm instead of SQLite. Then you provide <em>UserRepoRealm implements UserRepo</em> instead of <em>UserRepoSql implements UserRepo</em>. Still no need for <em>UserDataStore</em> and <em>UserDataStoreFactory</em>. My message here is: build the minimal piece of code you really need and don&rsquo;t over engineer it with requirements that may or may not be needed in the future. Seriously, I&rsquo;m working in this industry for quite some years now and I have never worked on a backend, not to mention an android app, that has ever changed the underlying database. Don&rsquo;t build an abstraction layer like <em>SqlSpecification</em> with such future requirements changes in mind. If one day you have to add something like a DiskCache along your cloud backend to communicate with, then it makes sense to refactor your code to respect the single responsibility principle and add classes like <em>UserDataStoreFactory</em>, <em>UserDataStore</em>, <em>DiskUserDataStore</em> and <em>CloudUserDataStore</em>. Since all your other layers are programming agains <em>UserRepo</em> interface, refactoring that is no problem at all.</p>
<p>Until then, no need for all this abstractions.</p>

        </article>
      </div>
      
    </div>
  </div>
</section>

<section>
    <div class="container">
        <div class="row justify-content-md-center">

            <div class="share-post-box">

                <a class="text-dark"
                    href="https://twitter.com/intent/tweet?text=&quot;The%20evolution%20of%20the%20Repository%20Pattern%20-%20Be%20aware%20of%20over%20abstraction&quot;%20https%3a%2f%2fhannesdorfmann.com%2fandroid%2ffrom-prefabricated-house-to-lego-house%2f%20via%20@sockeqwe"
                    target="_blank" title="Share on Twitter"><i class="ti-twitter-alt share-icon"></i></a>

                <a class="text-dark" href="http://www.reddit.com/submit?url=https%3a%2f%2fhannesdorfmann.com%2fandroid%2ffrom-prefabricated-house-to-lego-house%2f&title=The%20evolution%20of%20the%20Repository%20Pattern%20-%20Be%20aware%20of%20over%20abstraction"
                    target="_blank" title="Share on Reddit"><i class="ti-reddit share-icon"></i></a>


                <a class="text-dark" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fhannesdorfmann.com%2fandroid%2ffrom-prefabricated-house-to-lego-house%2f"
                    target="_blank" title="Share on LinkedIn"><i class="ti-linkedin share-icon"></i></a>

            </div>
        </div>
    </div>
</section>

<section>
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="widget">
  <h4 class="mb-4">LATEST POSTS</h4>
  
  <div class="media mb-4">
    <div class="media-body">
      <ul class="list-inline d-flex justify-content-between mb-2">
        <li class="list-inline-item">Jan 22, 2020</li>
      </ul>
      <h6><a class="text-dark" href="https://hannesdorfmann.com/posts/finding-the-right-abstraction-when-working-with-strings/">Finding the right abstraction (when working with Strings)</a></h6>
    </div>
  </div>
  
  <div class="media mb-4">
    <div class="media-body">
      <ul class="list-inline d-flex justify-content-between mb-2">
        <li class="list-inline-item">May 06, 2018</li>
      </ul>
      <h6><a class="text-dark" href="https://hannesdorfmann.com/android/mosby3-mvi-8/">Reactive Apps with Model-View-Intent - Part 8: Navigation</a></h6>
    </div>
  </div>
  
  <div class="media mb-4">
    <div class="media-body">
      <ul class="list-inline d-flex justify-content-between mb-2">
        <li class="list-inline-item">May 05, 2018</li>
      </ul>
      <h6><a class="text-dark" href="https://hannesdorfmann.com/android/coordinators-android/">In-App Navigation with Coordinators</a></h6>
    </div>
  </div>
  
</div>
      </div>
    </div>
  </div>
</section>


<footer class="bg-secondary">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-3 col-sm-6 mb-4 mb-md-0">
          
              <h6>Copyright &copy; 2021 <br /> Hannes Dorfmann</h6>
              <small>Theme based on hugo-parsa.</small>
        </div>
        <div class="col-md-3 col-sm-6 mb-4 mb-md-0">
          <h6>Categories in this Blog</h6>
          
          <ul class="list-inline tag-list">
            <li class="list-inline-item m-1"><a
                href="/categories/android">Android</a>
            </li>
            <li class="list-inline-item m-1"><a
                href="/categories/annotation-processor">Annotation-Processor</a>
            </li>
            <li class="list-inline-item m-1"><a
                href="/categories/java">Java</a>
            </li>
          </ul>

        </div>
        <div class="col-md-3 col-sm-6 mb-4 mb-md-0">
          <h6>Tags in this Blog</h6>
          
          <ul class="list-inline tag-list">
            <li class="list-inline-item m-1"><a
                href="/tags/algorithms">algorithms</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/android">android</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/database">database</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/design-patterns">design-patterns</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/java">java</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/library">library</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/navigation">navigation</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/software-architecture">software-architecture</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/ui">ui</a></li>
            <li class="list-inline-item m-1"><a
                href="/tags/ux">ux</a></li>
          </ul>
        </div>
        <div class="col-md-3 col-sm-6 mb-4 mb-md-0">
          <h6>Follow</h6>
          <ul class="list-inline d-inline-block">
            
            <li class="list-inline-item"><a href="" class="text-dark"><i class="ti-twitter-alt"></i></a></li>
            
            <li class="list-inline-item"><a href="" class="text-dark"><i class="ti-github"></i></a></li>
            
            <li class="list-inline-item"><a href="https://hannesdorfmann.com/index.xml" class="text-dark"><i class="ti-rss"></i></a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
</footer>



<script>
  var indexURL = "https://hannesdorfmann.com/index.json"
</script>


<!-- JS Plugins -->

<script src="https://hannesdorfmann.com/plugins/jQuery/jquery.min.js"></script>

<script src="https://hannesdorfmann.com/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://hannesdorfmann.com/plugins/slick/slick.min.js"></script>

<script src="https://hannesdorfmann.com/plugins/headroom/headroom.js"></script>

<script src="https://hannesdorfmann.com/plugins/masonry/masonry.js"></script>

<script src="https://hannesdorfmann.com/plugins/smooth-scroll/smooth-scroll.js"></script>

<script src="https://hannesdorfmann.com/plugins/search/fuse.min.js"></script>

<script src="https://hannesdorfmann.com/plugins/search/mark.js"></script>

<script src="https://hannesdorfmann.com/plugins/search/search.js"></script>


<!-- Main Script -->

<script src="https://hannesdorfmann.com/js/script.min.js"></script>

<!-- google analitycs -->

<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-54945521-1', 'auto');
  ga('send', 'pageview');
</script>





<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
  This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button"
    class="btn btn-sm btn-outline-light ml-2">I Accept</span>
</div>
<script>
  (function ($) {
    const cookieBox = document.getElementById('js-cookie-box');
    const cookieButton = document.getElementById('js-cookie-button');
    if (!Cookies.get('cookie-box')) {
      cookieBox.classList.remove('cookie-box-hide');
      cookieButton.onclick = function () {
        Cookies.set('cookie-box', true, {
          expires:  2 
    });
    cookieBox.classList.add('cookie-box-hide');
  };
		}
	}) (jQuery);
</script>


<style>
  .cookie-box {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    text-align: center;
    z-index: 9999;
    padding: 1rem 2rem;
    background: rgb(71, 71, 71);
    transition: all .75s cubic-bezier(.19, 1, .22, 1);
    color: #fdfdfd;
  }

  .cookie-box-hide {
    display: none;
  }
</style>
<script data-goatcounter="https://hannesdorfmann.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    </body>
</html>